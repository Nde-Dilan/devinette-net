/**
 * @fileoverview Firestore Security Rules for DevinetteNet.
 *
 * Core Philosophy:
 * This ruleset uses a single collection for all riddles. A 'status' field on each riddle
 * document determines its visibility. Riddles with a status of 'validated' are public.
 * Riddles with a status of 'pending' are not publicly readable.
 *
 * Data Structure:
 * - `/riddles/{riddleId}`: A single collection for all riddles.
 *   - `status`: A string field that can be 'pending' or 'validated'.
 *
 * Key Security Decisions:
 * - Public read access is granted only to riddles where `status == 'validated'`.
 * - Authenticated users can create new riddles, but they MUST have `status == 'pending'`.
 * - Server-side scripts (like the population script) are assumed to be unauthenticated and are
 *   allowed to create 'validated' riddles directly.
 * - Direct client-side updates and deletes are disallowed to maintain data integrity and workflow control.
 *   Admins will manage status changes from 'pending' to 'validated' via the Firebase Console or a trusted backend.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for the single riddles collection.
     * @path /riddles/{riddleId}
     */
    match /riddles/{riddleId} {
      /**
       * @description Allows public read access ONLY to validated riddles.
       * @allow (get) Anyone can read a single riddle if its status is 'validated'.
       * @allow (list) Anyone can list riddles, but the query MUST include `where('status', '==', 'validated')`.
       * @principle Enforces that only approved content is visible to users.
       */
      allow get: if resource.data.status == 'validated';
      allow list: if request.query.where.size() == 1 &&
                     request.query.where.status == 'validated';

      /**
       * @description Allows two types of creation:
       * 1. Authenticated users can submit PENDING riddles.
       * 2. Unauthenticated server-side processes can create VALIDATED riddles.
       * @allow (create) An authenticated user can submit a new riddle, or a server process can populate validated ones.
       * @principle Ensures user content goes through moderation, while trusted scripts can bypass it.
       */
      allow create: if (isSignedIn() && request.resource.data.status == 'pending') ||
                       (!isSignedIn() && request.resource.data.status == 'validated');


      /**
       * @description Denies all updates and deletes from the client.
       * @deny (update, delete) Updates and deletions must be handled by a trusted backend or admin.
       * @principle Prevents users from altering their own or others' submissions, or changing a riddle's status.
       */
      allow update, delete: if false;
    }

    // Helper function to check if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }
  }
}
